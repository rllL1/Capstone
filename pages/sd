<?php
include '../config/db.php';
session_start();
if (!isset($_SESSION['user_id'])) { header("Location: login.php"); exit; }

// Get current hour and set timezone
date_default_timezone_set('Asia/Manila');
$hour = (int)date('H');

// Define greeting based on time
if ($hour >= 5 && $hour < 12) {
    $timeOfDay = 'morning';
} elseif ($hour >= 12 && $hour < 17) {
    $timeOfDay = 'afternoon';
} elseif ($hour >= 17 && $hour < 19) {
    $timeOfDay = 'evening';
} else {
    $timeOfDay = 'night';
}

$greet = 'Good ' . $timeOfDay;

// Basic Statistics
$totalEmployees = $conn->query("SELECT COUNT(*) AS t FROM employees WHERE deleted_at IS NULL")->fetch_assoc()['t'] ?? 0;
$totalPayrolls = $conn->query("SELECT COUNT(DISTINCT emp_id) AS t FROM payrolls WHERE YEAR(pay_date) = YEAR(CURDATE())")->fetch_assoc()['t'] ?? 0;
$totalDepartments = $conn->query("SELECT COUNT(DISTINCT department) AS t FROM employees WHERE department IS NOT NULL")->fetch_assoc()['t'] ?? 0;

// Current Month Summary
$summary = $conn->query("
    SELECT 
        COALESCE(SUM(net_pay), 0) AS total_net,
        COALESCE(SUM(deductions), 0) AS total_ded,
        COALESCE(AVG(basic_pay), 0) AS avg_salary
    FROM payrolls 
    WHERE DATE_FORMAT(pay_date, '%Y-%m') = DATE_FORMAT(CURDATE(), '%Y-%m')
")->fetch_assoc();

$total_net = (float)($summary['total_net'] ?? 0);
$total_ded = (float)($summary['total_ded'] ?? 0);
$avg_salary = (float)($summary['avg_salary'] ?? 0);

// Highest Paid Employee
$top = $conn->query("
    SELECT 
        emp_name,
        salary,
        position,
        department
    FROM employees 
    ORDER BY salary DESC 
    LIMIT 1
")->fetch_assoc();

// Monthly payroll chart data
$months = []; $totals = [];
$res = $conn->query("
    SELECT 
        DATE_FORMAT(pay_date,'%b') AS m,
        COALESCE(SUM(net_pay), 0) AS s
    FROM payrolls 
    WHERE pay_date >= DATE_SUB(CURDATE(), INTERVAL 6 MONTH)
    GROUP BY DATE_FORMAT(pay_date,'%Y-%m')
    ORDER BY pay_date ASC
");
while($r = $res->fetch_assoc()) {
    $months[] = $r['m'];
    $totals[] = (float)$r['s'];
}

// Department distribution
$deptLabels = []; $deptTotals = [];
$res2 = $conn->query("
    SELECT 
        department,
        COUNT(*) AS total
    FROM employees 
    WHERE deleted_at IS NULL 
    AND department IS NOT NULL
    GROUP BY department
    ORDER BY total DESC
");
while($r2 = $res2->fetch_assoc()) {
    $deptLabels[] = $r2['department'];
    $deptTotals[] = (int)$r2['total'];
}

// Salary vs Deductions
$d = $conn->query("SELECT SUM(basic_pay) AS s, SUM(deductions) AS d FROM payrolls")->fetch_assoc();
$total_salary = (float)($d['s'] ?? 0);
$total_deductions = (float)($d['d'] ?? 0);
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dashboard - Payroll System</title>
    <link rel="stylesheet" href="../style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .greeting {
            background: linear-gradient(135deg, #2e7d32 0%, #3cbb44ff 100%);
            color: white;
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(46,125,50,0.2);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .greeting h2 {
            margin: 0;
            font-size: 1.8rem;
        }

        .greeting p {
            margin: 5px 0 0;
            opacity: 0.9;
        }

        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(145deg, #ffffff, #f8f9fa);
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border-left: 4px solid #2e7d32;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .stat-card h4 {
            margin: 0;
            color: #1b5e20;
            font-weight: 600;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stat-card h4 i {
            font-size: 1.2rem;
            background: #e8f5e9;
            color: #2e7d32;
            padding: 10px;
            border-radius: 12px;
        }

        .stat-card p {
            margin: 15px 0 5px;
            font-size: 2rem;
            font-weight: 700;
            color: #1b5e20;
        }

        .stat-card small {
            color: #66bb6a;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .chart-box {
            background: #ffffff;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .chart-box h4 {
            margin: 0 0 15px;
            color: #1b5e20;
            font-size: 1rem;
            font-weight: 600;
        }

        .table-wrap {
            margin-top: 20px;
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th, .table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e8f5e9;
        }

        .table th {
            background: #f8f9fa;
            color: #1b5e20;
            font-weight: 600;
        }

        .table tbody tr:hover {
            background: #f8f9fa;
        }

        @media (max-width: 768px) {
            .charts {
                grid-template-columns: 1fr;
            }
            
            .stat-card {
                padding: 20px;
            }
            
            .greeting {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <?php include '../includes/sidebar.php'; ?>
    <div class="main-area">
        <?php include '../includes/header.php'; ?>
        
        <section class="content">
            <div class="content-card">
                <!-- Greeting Section -->
                <div class="greeting <?= $timeOfDay ?>">
                    <h2><?= $greet ?>, <?= htmlspecialchars($_SESSION['username'] ?? 'Admin') ?>!</h2>
                    <p>Here's your payroll system overview for today.</p>
                </div>

                <!-- Statistics Cards -->
                <div class="cards">
                    <div class="stat-card">
                        <h4><i class="fas fa-users"></i> Total Employees</h4>
                        <p><?= number_format($totalEmployees) ?></p>
                        <small>Active employees</small>
                    </div>
                    <div class="stat-card">
                        <h4><i class="fas fa-building"></i> Departments</h4>
                        <p><?= number_format($totalDepartments) ?></p>
                        <small>Active departments</small>
                    </div>
                    <div class="stat-card">
                        <h4><i class="fas fa-file-invoice-dollar"></i> Payrolls</h4>
                        <p><?= number_format($totalPayrolls) ?></p>
                        <small>This year's records</small>
                    </div>
                    <div class="stat-card">
                        <h4><i class="fas fa-chart-line"></i> Average Salary</h4>
                        <p>₱<?= number_format($avg_salary, 2) ?></p>
                        <small>Per employee</small>
                    </div>
                </div>

                <!-- Monthly Summary -->
                <div class="cards">
                    <div class="stat-card">
                        <h4><i class="fas fa-money-bill-wave"></i> Net Pay</h4>
                        <p>₱<?= number_format($total_net, 2) ?></p>
                        <small>This month's total</small>
                    </div>
                    <div class="stat-card">
                        <h4><i class="fas fa-calculator"></i> Deductions</h4>
                        <p>₱<?= number_format($total_ded, 2) ?></p>
                        <small>This month's total</small>
                    </div>
                    <div class="stat-card">
                        <h4><i class="fas fa-trophy"></i> Top Earner</h4>
                        <p><?= htmlspecialchars($top['emp_name'] ?? 'N/A') ?></p>
                        <small>₱<?= number_format($top['salary'] ?? 0, 2) ?> monthly</small>
                    </div>
                </div>

                <!-- Charts -->
                <div class="charts">
                    <div class="chart-box">
                        <h4><i class="fas fa-chart-bar"></i> Monthly Payroll Distribution</h4>
                        <canvas id="payrollChart"></canvas>
                    </div>
                    <div class="chart-box">
                        <h4><i class="fas fa-chart-pie"></i> Department Distribution</h4>
                        <canvas id="deptChart"></canvas>
                    </div>
                    <div class="chart-box">
                        <h4><i class="fas fa-balance-scale"></i> Salary vs Deductions</h4>
                        <canvas id="salaryChart"></canvas>
                    </div>
                </div>

                <!-- Recent Records -->
                <div class="table-wrap" style="margin-top:20px;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Recent Activity</th>
                                <th>Department</th>
                                <th>Amount</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php
                            $recent = $conn->query("
                                SELECT 
                                    p.pay_date,
                                    e.emp_name,
                                    p.net_pay,
                                    e.department as dept_name
                                FROM payrolls p 
                                JOIN employees e ON p.emp_id = e.id 
                                WHERE e.deleted_at IS NULL
                                ORDER BY p.pay_date DESC 
                                LIMIT 5
                            ");
                            
                            if($recent->num_rows > 0) {
                                while($row = $recent->fetch_assoc()) {
                                    echo "<tr>
                                        <td>" . htmlspecialchars($row['emp_name']) . "</td>
                                        <td>" . htmlspecialchars($row['dept_name']) . "</td>
                                        <td>₱" . number_format($row['net_pay'], 2) . "</td>
                                        <td>" . date('M d, Y', strtotime($row['pay_date'])) . "</td>
                                    </tr>";
                                }
                            } else {
                                echo "<tr><td colspan='4' style='text-align:center;'>No recent activities</td></tr>";
                            }
                            ?>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </div>

    <script>
        // Chart.js Configurations
        const chartConfig = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true,
                        font: { size: 12 }
                    }
                }
            }
        };

        // Monthly Payroll Chart
        new Chart(document.getElementById('payrollChart'), {
            type: 'bar',
            data: {
                labels: <?= json_encode($months) ?>,
                datasets: [{
                    label: 'Net Pay (₱)',
                    data: <?= json_encode($totals) ?>,
                    backgroundColor: 'rgba(46, 125, 50, 0.7)',
                    borderColor: 'rgba(46, 125, 50, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                ...chartConfig,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: value => '₱' + value.toLocaleString()
                        }
                    }
                }
            }
        });

        // Department Distribution Chart
        new Chart(document.getElementById('deptChart'), {
            type: 'doughnut',
            data: {
                labels: <?= json_encode($deptLabels) ?>,
                datasets: [{
                    data: <?= json_encode($deptTotals) ?>,
                    backgroundColor: [
                        'rgba(46, 125, 50, 0.7)',
                        'rgba(56, 142, 60, 0.7)',
                        'rgba(67, 160, 71, 0.7)',
                        'rgba(76, 175, 80, 0.7)',
                        'rgba(102, 187, 106, 0.7)',
                        'rgba(129, 199, 132, 0.7)'
                    ]
                }]
            },
            options: chartConfig
        });

        // Salary vs Deductions Chart
        new Chart(document.getElementById('salaryChart'), {
            type: 'pie',
            data: {
                labels: ['Net Salary', 'Deductions'],
                datasets: [{
                    data: [<?= $total_salary ?>, <?= $total_deductions ?>],
                    backgroundColor: [
                        'rgba(46, 125, 50, 0.7)',
                        'rgba(211, 47, 47, 0.7)'
                    ]
                }]
            },
            options: chartConfig
        });
    </script>
</body>
</html>
 